name: Build & deploy GitHub Pages (hourly + on-demand)

# Uruchomienia: push na main, ręcznie (workflow_dispatch) oraz co godzinę (cron)
on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '15 * * * *'    # co godzinę, minuta 15

# Zapewniamy, że równoległe runy nie będą się ze sobą gryźć
concurrency:
  group: pages-deploy-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: Build and prepare artifact

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies if needed
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "no package.json -> skip npm install"
          fi

      - name: Ensure clean public folder
        run: |
          rm -rf public || true
          mkdir -p public

      - name: Run generator (create mergedPriceList.json)
        id: generate
        run: |
          echo "Running generator: node mergePrices.mjs"
          # jeśli generator jest w innej lokalizacji lub wymaga npm run -> zmień tę linię
          node mergePrices.mjs
          rc=$?
          echo "Generator exit code: $rc"
          if [ $rc -ne 0 ]; then
            echo "ERROR: generator failed (exit $rc)" >&2
            exit $rc
          fi
          if [ ! -f mergedPriceList.json ]; then
            echo "ERROR: mergedPriceList.json not found after generator" >&2
            ls -la || true
            exit 1
          fi
          # walidacja JSON
          node -e "JSON.parse(require('fs').readFileSync('mergedPriceList.json','utf8')); console.log('mergedPriceList.json OK')"

      - name: Move artifact to public/
        run: |
          mv -f mergedPriceList.json public/ || (echo "move failed" && ls -la && exit 1)
          if [ -f index.html ]; then cp -n index.html public/; else cat > public/index.html <<'HTML'
<!doctype html>
<meta charset="utf-8">
<title>Prices - mergedPriceList.json</title>
<h1>Prices (auto-generated)</h1>
<p><a href="./mergedPriceList.json">mergedPriceList.json</a></p>
HTML
          fi
          echo "public/ contents:" && ls -la public

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: build
    runs-on: ubuntu-latest
    name: Deploy artifact to GitHub Pages
    steps:
      - name: Deploy
        uses: actions/deploy-pages@v4
