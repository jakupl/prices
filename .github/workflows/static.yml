name: Build & deploy GitHub Pages (generate mergedPriceList.json first)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    # co godzinę: minuta 15 (unikamy pełnej godziny)
    - cron: '15 * * * *'

concurrency:
  group: pages-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    name: Build site & prepare Pages artifact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies (if present)
        run: |
          if [ -f package.json ]; then
            echo "package.json found — running npm ci"
            npm ci
          else
            echo "no package.json — skipping npm install"
          fi

      - name: Clean previous outputs (safety)
        run: |
          rm -rf public || true
          mkdir -p public

      - name: Generate mergedPriceList.json
        id: gen
        run: |
          echo "-> Running generator: node mergePrices.mjs"
          # Jeśli masz inną komendę, zamień poniższą linię:
          node mergePrices.mjs
          echo "-> generator exit code: $?"
          if [ ! -f mergedPriceList.json ]; then
            echo "ERROR: mergedPriceList.json not found after running generator" >&2
            ls -la
            exit 1
          fi
          # szybka walidacja JSON (zakończy job przy błędzie parsowania)
          node -e "JSON.parse(require('fs').readFileSync('mergedPriceList.json','utf8')); console.log('mergedPriceList.json: valid JSON')"

      - name: Move generated file to publish folder
        run: |
          mv -f mergedPriceList.json public/
          # jeżeli masz index.html w repo — skopiuj, w przeciwnym razie utwórz prosty placeholder
          if [ -f index.html ]; then
            cp -n index.html public/
          else
            cat > public/index.html <<'HTML'
<!doctype html>
<meta charset="utf-8">
<title>Prices - mergedPriceList.json</title>
<h1>Prices (auto-generated)</h1>
<p><a href="./mergedPriceList.json">Pobierz mergedPriceList.json</a></p>
HTML
          fi

      - name: Show public folder contents (debug)
        run: |
          echo "---- public/ listing ----"
          ls -la public || true
          echo "---- sizes ----"
          du -sh public || true

      - name: Create tar of public (debug + ensure upload)
        run: |
          tar -czf public.tar.gz -C public .
          echo "public tar created"
          ls -lh public.tar.gz || true

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    name: Deploy artifact to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Show deployment URL
        if: success()
        run: |
          echo "Deployment job finished. See logs above for the published URL (deploy step prints it)."
