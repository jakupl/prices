<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lista cen</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; padding:20px; background:#f7f8fa; color:#111}
    h1{font-size:1.4rem; margin-bottom:0.5rem}
    .notice{margin:1rem 0; padding:0.6rem 0.8rem; border-radius:8px; background:#fff; box-shadow:0 1px 3px rgba(0,0,0,0.04)}
    table{width:100%; border-collapse:collapse; margin-top:1rem; background:#fff; box-shadow:0 1px 2px rgba(0,0,0,0.03)}
    th,td{padding:0.65rem 0.8rem; border-bottom:1px solid #eee; text-align:left; font-size:0.95rem}
    th{background:#fafafa; font-weight:600; position:sticky; top:0}
    tbody tr:hover{background:#fbfbff}
    .error{color:#8a1f1f; background:#fff1f1; border-left:4px solid #f1a; padding:0.6rem; border-radius:6px; margin-top:1rem}
    .small{font-size:0.85rem; color:#666}
    #reload{margin-left:0.5rem}
    .center{display:flex; gap:8px; align-items:center}
  </style>
</head>
<body>
  <h1>Lista cen</h1>

  <div class="notice">
    <div class="center">
      <div class="small">Dane pobierane z <code>./mergedPriceList.json</code></div>
      <button id="reload">Odśwież</button>
    </div>
  </div>

  <div id="status" class="small">Ładowanie…</div>
  <div id="tableWrap" style="margin-top:12px"></div>

  <script>
    async function buildTable(data) {
      const wrap = document.getElementById('tableWrap');
      wrap.innerHTML = '';
      if (!data) {
        wrap.innerHTML = '<div class="error">Brak danych do wyświetlenia.</div>';
        return;
      }

      // Jeśli top-level to obiekt z kluczem listy, spróbuj odczytać
      if (!Array.isArray(data)) {
        // znajdź pierwsze pole będące tablicą obiektów
        for (const k of Object.keys(data)) {
          if (Array.isArray(data[k])) { data = data[k]; break; }
        }
      }

      if (!Array.isArray(data) || data.length === 0) {
        wrap.innerHTML = '<div class="error">Dane są puste lub nie są listą obiektów.</div>';
        return;
      }

      // Kolumny: zsumuj klucze z pierwszych kilkunastu elementów
      const keySet = new Set();
      for (let i=0; i< Math.min(30, data.length); i++) {
        const item = data[i];
        if (item && typeof item === 'object') {
          Object.keys(item).forEach(k => keySet.add(k));
        }
      }
      const cols = Array.from(keySet);

      // Tworzenie tabeli
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      cols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      data.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(c => {
          const td = document.createElement('td');
          let v = row == null ? '' : row[c];
          if (v === null || typeof v === 'undefined') v = '';
          // ładne formatowanie obiektów/arrayów
          if (typeof v === 'object') v = JSON.stringify(v);
          td.textContent = v;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
    }

    async function loadAndRender() {
      const status = document.getElementById('status');
      status.textContent = 'Pobieram ./mergedPriceList.json ...';
      try {
        const resp = await fetch('./mergedPriceList.json', {cache: "no-cache"});
        if (!resp.ok) {
          throw new Error('HTTP ' + resp.status + ' ' + resp.statusText);
        }
        const json = await resp.json();
        status.textContent = 'Dane załadowane. Pokazuję tabelę.';
        await buildTable(json);
      } catch (err) {
        status.innerHTML = `<div class="error">Błąd podczas wczytywania danych: ${String(err)}</div>
          <div class="small">Sprawdź w konsoli (F12) szczegóły.</div>`;
        console.error(err);
      }
    }

    document.getElementById('reload').addEventListener('click', () => {
      loadAndRender();
    });

    // uruchom od razu
    loadAndRender();
  </script>
</body>
</html>
